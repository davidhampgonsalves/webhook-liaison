'use strict'

var test = require('tape');
var _ = require('underscore')
require('json5/lib/require')

var webhookTransmogrifier = require('..').webhookTransmogrifier

var configs = require('./travis-configs.json5')

test('expand uri encoded json form parameter for travis', function (t) {
  t.plan(2);

  const input = "payload=%7B%22id%22%3A1%2C%22number%22%3A%221%22%2C%22status%22%3Anull%2C%22started_at%22%3Anull%2C%22finished_at%22%3Anull%2C%22status_message%22%3A%22Fixed%22%2C%22commit%22%3A%2262aae5f70ceee39123ef%22%2C%22branch%22%3A%22master%22%2C%22message%22%3A%22the%20commit%20message%22%2C%22compare_url%22%3A%22https%3A%2F%2Fgithub.com%2Fsvenfuchs%2Fminimal%2Fcompare%2Fmaster...develop%22%2C%22committed_at%22%3A%222011-11-11T11%3A%2011%3A%2011Z%22%2C%22committer_name%22%3A%22Sven%20Fuchs%22%2C%22committer_email%22%3A%22svenfuchs%40artweb-design.de%22%2C%22author_name%22%3A%22Sven%20Fuchs%22%2C%22author_email%22%3A%22svenfuchs%40artweb-design.de%22%2C%22type%22%3A%22push%22%2C%22build_url%22%3A%22https%3A%2F%2Ftravis-ci.org%2Fsvenfuchs%2Fminimal%2Fbuilds%2F1%22%2C%22repository%22%3A%7B%22id%22%3A1%2C%22name%22%3A%22minimal%22%2C%22owner_name%22%3A%22svenfuchs%22%2C%22url%22%3A%22http%3A%2F%2Fgithub.com%2Fsvenfuchs%2Fminimal%22%7D%2C%22config%22%3A%7B%22notifications%22%3A%7B%22webhooks%22%3A%5B%22http%3A%2F%2Fevome.fr%2Fnotifications%22%2C%22http%3A%2F%2Fexample.com%2F%22%5D%7D%7D%2C%22matrix%22%3A%5B%7B%22id%22%3A2%2C%22repository_id%22%3A1%2C%22number%22%3A%221.1%22%2C%22state%22%3A%22created%22%2C%22started_at%22%3Anull%2C%22finished_at%22%3Anull%2C%22config%22%3A%7B%22notifications%22%3A%7B%22webhooks%22%3A%5B%22http%3A%2F%2Fevome.fr%2Fnotifications%22%2C%22http%3A%2F%2Fexample.com%2F%22%5D%7D%7D%2C%22status%22%3Anull%2C%22log%22%3A%22%22%2C%22result%22%3Anull%2C%22parent_id%22%3A1%2C%22commit%22%3A%2262aae5f70ceee39123ef%22%2C%22branch%22%3A%22master%22%2C%22message%22%3A%22the%20commit%20message%22%2C%22committed_at%22%3A%222011-11-11T11%3A%2011%3A%2011Z%22%2C%22committer_name%22%3A%22Sven%20Fuchs%22%2C%22committer_email%22%3A%22svenfuchs%40artweb-design.de%22%2C%22author_name%22%3A%22Sven%20Fuchs%22%2C%22author_email%22%3A%22svenfuchs%40artweb-design.de%22%2C%22compare_url%22%3A%22https%3A%2F%2Fgithub.com%2Fsvenfuchs%2Fminimal%2Fcompare%2Fmaster...develop%22%7D%5D%7D"
  const eventJson = {
    configName: 'travis-ci',
    method: "Post",
    contentType: 'application/x-www-form-urlencoded',
    body: input,
  }

  webhookTransmogrifier.process(eventJson, function(results) {
    t.equal(results.sent.length, 1, 'should be sent')
    debugger
    t.same(results.sent[0].json, { message: "Tests are Fixed on master b/c: the commit message" }, 'should be expected message')
  }, configs)
})


test('expand process travis event', function (t) {
  t.plan(2);
  const eventJson = {
    configName: 'travis-ci',
    method: 'POST',
    contentType: 'application/x-www-form-urlencoded',
    body: 'payload=%7B%22id%22%3A23995640%2C%22repository%22%3A%7B%22id%22%3A136292%2C%22name%22%3A%22opencounter%22%2C%22owner_name%22%3A%22opencounter%22%2C%22url%22%3A%22opencounter.us%22%7D%2C%22number%22%3A%227513%22%2C%22config%22%3A%7B%22language%22%3A%22ruby%22%2C%22sudo%22%3Afalse%2C%22rvm%22%3A%5B%222.2.3%22%5D%2C%22script%22%3A%5B%22script%2Ftest%22%5D%2C%22before_script%22%3A%5B%22cp+config%2Fdatabase.travis.yml+config%2Fdatabase.yml%22%2C%22psql+-c+%27create+database+opencounter_test%3B%27+-U+postgres%22%5D%2C%22addons%22%3A%7B%22postgresql%22%3A%229.4%22%7D%2C%22cache%22%3A%22bundler%22%2C%22env%22%3A%5B%22%5BOne+of+the+secure+variables+in+your+.travis.yml+has+an+invalid+format.%5D%22%5D%2C%22notifications%22%3A%7B%22webhooks%22%3A%22https%3A%2F%2Fot6koo12f9.execute-api.us-west-2.amazonaws.com%2Fwebhooktransmogrifier%2Ftransmogrify%2Ftravis-ci%22%7D%2C%22.result%22%3A%22configured%22%7D%2C%22status%22%3A1%2C%22result%22%3A1%2C%22status_message%22%3A%22Broken%22%2C%22result_message%22%3A%22Broken%22%2C%22started_at%22%3A%222016-04-17T00%3A40%3A13Z%22%2C%22finished_at%22%3A%222016-04-17T00%3A43%3A35Z%22%2C%22duration%22%3A202%2C%22build_url%22%3A%22https%3A%2F%2Ftravis-ci.com%2Fopencounter%2Fopencounter%2Fbuilds%2F23995640%22%2C%22commit_id%22%3A34001880%2C%22commit%22%3A%224fce43dfeaf8827e06c56c6f34f87342545199cc%22%2C%22base_commit%22%3Anull%2C%22head_commit%22%3Anull%2C%22branch%22%3A%22important-branch%22%2C%22message%22%3A%22add+travis+github+notifications%22%2C%22compare_url%22%3A%22https%3A%2F%2Fgithub.com%2Fopencounter%2Fopencounter%2Fcompare%2Fe7dd654b9386...4fce43dfeaf8%22%2C%22committed_at%22%3A%222016-04-17T00%3A39%3A25Z%22%2C%22author_name%22%3A%22David+Hamp-Gonsalves%22%2C%22author_email%22%3A%22davidhampgonsalves%40gmail.com%22%2C%22committer_name%22%3A%22David+Hamp-Gonsalves%22%2C%22committer_email%22%3A%22davidhampgonsalves%40gmail.com%22%2C%22matrix%22%3A%5B%7B%22id%22%3A37760157%2C%22repository_id%22%3A136292%2C%22parent_id%22%3A23995640%2C%22number%22%3A%227513.1%22%2C%22state%22%3A%22finished%22%2C%22config%22%3A%7B%22language%22%3A%22ruby%22%2C%22sudo%22%3Afalse%2C%22rvm%22%3A%222.2.3%22%2C%22script%22%3A%5B%22script%2Ftest%22%5D%2C%22before_script%22%3A%5B%22cp+config%2Fdatabase.travis.yml+config%2Fdatabase.yml%22%2C%22psql+-c+%27create+database+opencounter_test%3B%27+-U+postgres%22%5D%2C%22addons%22%3A%7B%22postgresql%22%3A%229.4%22%7D%2C%22cache%22%3A%22bundler%22%2C%22notifications%22%3A%7B%22webhooks%22%3A%22https%3A%2F%2Fot6koo12f9.execute-api.us-west-2.amazonaws.com%2Fwebhooktransmogrifier%2Ftransmogrify%2Ftravis-ci%22%7D%2C%22.result%22%3A%22configured%22%2C%22global_env%22%3A%5B%22ARCGIS_HOST%3DARCGIS_HOST%22%2C%22ARCGIS_GEOCODE_PATH%3DARCGIS_GEOCODE_PATH%22%2C%22ARCGIS_REVERSE_GEOCODE_PATH%3DARCGIS_REVERSE_GEOCODE_PATH%22%2C%22BRAINTREE_ENV%3DBRAINTREE_ENV%22%2C%22BRAINTREE_MERCHANT_ID%3DBRAINTREE_MERCHANT_ID%22%2C%22BRAINTREE_PUBLIC_KEY%3DBRAINTREE_PUBLIC_KEY%22%2C%22BRAINTREE_PRIVATE_KEY%3DBRAINTREE_PRIVATE_KEY%22%2C%22FACEBOOK_APP_ID%3DFACEBOOK_APP_ID%22%2C%22FACEBOOK_APP_SECRET%3DFACEBOOK_APP_SECRET%22%2C%22FACTUAL_API_KEY%3DFACTUAL_API_KEY%22%2C%22FACTUAL_API_SECRET%3DFACTUAL_API_SECRET%22%2C%22GOOGLE_API_KEY%3DGOOGLE_API_KEY%22%2C%22GOOGLE_CLIENT_ID%3DGOOGLE_CLIENT_ID%22%2C%22GOOGLE_CLIENT_SECRET%3DGOOGLE_CLIENT_SECRET%22%2C%22HELLO_SIGN_API_KEY%3DHELLO_SIGN_API_KEY%22%2C%22HELLO_SIGN_CLIENT_ID%3DHELLO_SIGN_CLIENT_ID%22%2C%22INVOICE_CLOUD_BILLER_GUID%3DINVOICE_CLOUD_BILLER_GUID%22%2C%22INVOICE_CLOUD_WEB_KEY%3DINVOICE_CLOUD_WEB_KEY%22%2C%22LINKEDIN_CONSUMER_KEY%3DLINKEDIN_CONSUMER_KEY%22%2C%22LINKEDIN_CONSUMER_SECRET%3DLINKEDIN_CONSUMER_SECRET%22%2C%22TWILIO_ACCOUNT_SID%3DTWILIO_ACCOUNT_SID%22%2C%22TWILIO_AUTH_TOKEN%3DTWILIO_AUTH_TOKEN%22%2C%22TWITTER_API_KEY%3DTWITTER_API_KEY%22%2C%22TWITTER_API_SECRET%3DTWITTER_API_SECRET%22%5D%2C%22group%22%3A%22stable%22%2C%22dist%22%3A%22precise%22%2C%22os%22%3A%22linux%22%7D%2C%22status%22%3A1%2C%22result%22%3A1%2C%22commit%22%3A%224fce43dfeaf8827e06c56c6f34f87342545199cc%22%2C%22branch%22%3A%22important-branch%22%2C%22message%22%3A%22add+travis+github+notifications%22%2C%22compare_url%22%3A%22https%3A%2F%2Fgithub.com%2Fopencounter%2Fopencounter%2Fcompare%2Fe7dd654b9386...4fce43dfeaf8%22%2C%22started_at%22%3A%222016-04-17T00%3A40%3A13Z%22%2C%22finished_at%22%3A%222016-04-17T00%3A43%3A35Z%22%2C%22committed_at%22%3A%222016-04-17T00%3A39%3A25Z%22%2C%22author_name%22%3A%22David+Hamp-Gonsalves%22%2C%22author_email%22%3A%22davidhampgonsalves%40gmail.com%22%2C%22committer_name%22%3A%22David+Hamp-Gonsalves%22%2C%22committer_email%22%3A%22davidhampgonsalves%40gmail.com%22%2C%22allow_failure%22%3Afalse%7D%5D%2C%22type%22%3A%22push%22%2C%22state%22%3A%22failed%22%2C%22pull_request%22%3Afalse%2C%22pull_request_number%22%3Anull%2C%22pull_request_title%22%3Anull%2C%22tag%22%3Anull%7D', json: 'payload=%7B%22id%22%3A23995640%2C%22repository%22%3A%7B%22id%22%3A136292%2C%22name%22%3A%22opencounter%22%2C%22owner_name%22%3A%22opencounter%22%2C%22url%22%3A%22opencounter.us%22%7D%2C%22number%22%3A%227513%22%2C%22config%22%3A%7B%22language%22%3A%22ruby%22%2C%22sudo%22%3Afalse%2C%22rvm%22%3A%5B%222.2.3%22%5D%2C%22script%22%3A%5B%22script%2Ftest%22%5D%2C%22before_script%22%3A%5B%22cp+config%2Fdatabase.travis.yml+config%2Fdatabase.yml%22%2C%22psql+-c+%27create+database+opencounter_test%3B%27+-U+postgres%22%5D%2C%22addons%22%3A%7B%22postgresql%22%3A%229.4%22%7D%2C%22cache%22%3A%22bundler%22%2C%22env%22%3A%5B%22%5BOne+of+the+secure+variables+in+your+.travis.yml+has+an+invalid+format.%5D%22%5D%2C%22notifications%22%3A%7B%22webhooks%22%3A%22https%3A%2F%2Fot6koo12f9.execute-api.us-west-2.amazonaws.com%2Fwebhooktransmogrifier%2Ftransmogrify%2Ftravis-ci%22%7D%2C%22.result%22%3A%22configured%22%7D%2C%22status%22%3A1%2C%22result%22%3A1%2C%22status_message%22%3A%22Broken%22%2C%22result_message%22%3A%22Broken%22%2C%22started_at%22%3A%222016-04-17T00%3A40%3A13Z%22%2C%22finished_at%22%3A%222016-04-17T00%3A43%3A35Z%22%2C%22duration%22%3A202%2C%22build_url%22%3A%22https%3A%2F%2Ftravis-ci.com%2Fopencounter%2Fopencounter%2Fbuilds%2F23995640%22%2C%22commit_id%22%3A34001880%2C%22commit%22%3A%224fce43dfeaf8827e06c56c6f34f87342545199cc%22%2C%22base_commit%22%3Anull%2C%22head_commit%22%3Anull%2C%22branch%22%3A%22important-branch%22%2C%22message%22%3A%22add+travis+github+notifications%22%2C%22compare_url%22%3A%22https%3A%2F%2Fgithub.com%2Fopencounter%2Fopencounter%2Fcompare%2Fe7dd654b9386...4fce43dfeaf8%22%2C%22committed_at%22%3A%222016-04-17T00%3A39%3A25Z%22%2C%22author_name%22%3A%22David+Hamp-Gonsalves%22%2C%22author_email%22%3A%22davidhampgonsalves%40gmail.com%22%2C%22committer_name%22%3A%22David+Hamp-Gonsalves%22%2C%22committer_email%22%3A%22davidhampgonsalves%40gmail.com%22%2C%22matrix%22%3A%5B%7B%22id%22%3A37760157%2C%22repository_id%22%3A136292%2C%22parent_id%22%3A23995640%2C%22number%22%3A%227513.1%22%2C%22state%22%3A%22finished%22%2C%22config%22%3A%7B%22language%22%3A%22ruby%22%2C%22sudo%22%3Afalse%2C%22rvm%22%3A%222.2.3%22%2C%22script%22%3A%5B%22script%2Ftest%22%5D%2C%22before_script%22%3A%5B%22cp+config%2Fdatabase.travis.yml+config%2Fdatabase.yml%22%2C%22psql+-c+%27create+database+opencounter_test%3B%27+-U+postgres%22%5D%2C%22addons%22%3A%7B%22postgresql%22%3A%229.4%22%7D%2C%22cache%22%3A%22bundler%22%2C%22notifications%22%3A%7B%22webhooks%22%3A%22https%3A%2F%2Fot6koo12f9.execute-api.us-west-2.amazonaws.com%2Fwebhooktransmogrifier%2Ftransmogrify%2Ftravis-ci%22%7D%2C%22.result%22%3A%22configured%22%2C%22global_env%22%3A%5B%22ARCGIS_HOST%3DARCGIS_HOST%22%2C%22ARCGIS_GEOCODE_PATH%3DARCGIS_GEOCODE_PATH%22%2C%22ARCGIS_REVERSE_GEOCODE_PATH%3DARCGIS_REVERSE_GEOCODE_PATH%22%2C%22BRAINTREE_ENV%3DBRAINTREE_ENV%22%2C%22BRAINTREE_MERCHANT_ID%3DBRAINTREE_MERCHANT_ID%22%2C%22BRAINTREE_PUBLIC_KEY%3DBRAINTREE_PUBLIC_KEY%22%2C%22BRAINTREE_PRIVATE_KEY%3DBRAINTREE_PRIVATE_KEY%22%2C%22FACEBOOK_APP_ID%3DFACEBOOK_APP_ID%22%2C%22FACEBOOK_APP_SECRET%3DFACEBOOK_APP_SECRET%22%2C%22FACTUAL_API_KEY%3DFACTUAL_API_KEY%22%2C%22FACTUAL_API_SECRET%3DFACTUAL_API_SECRET%22%2C%22GOOGLE_API_KEY%3DGOOGLE_API_KEY%22%2C%22GOOGLE_CLIENT_ID%3DGOOGLE_CLIENT_ID%22%2C%22GOOGLE_CLIENT_SECRET%3DGOOGLE_CLIENT_SECRET%22%2C%22HELLO_SIGN_API_KEY%3DHELLO_SIGN_API_KEY%22%2C%22HELLO_SIGN_CLIENT_ID%3DHELLO_SIGN_CLIENT_ID%22%2C%22INVOICE_CLOUD_BILLER_GUID%3DINVOICE_CLOUD_BILLER_GUID%22%2C%22INVOICE_CLOUD_WEB_KEY%3DINVOICE_CLOUD_WEB_KEY%22%2C%22LINKEDIN_CONSUMER_KEY%3DLINKEDIN_CONSUMER_KEY%22%2C%22LINKEDIN_CONSUMER_SECRET%3DLINKEDIN_CONSUMER_SECRET%22%2C%22TWILIO_ACCOUNT_SID%3DTWILIO_ACCOUNT_SID%22%2C%22TWILIO_AUTH_TOKEN%3DTWILIO_AUTH_TOKEN%22%2C%22TWITTER_API_KEY%3DTWITTER_API_KEY%22%2C%22TWITTER_API_SECRET%3DTWITTER_API_SECRET%22%5D%2C%22group%22%3A%22stable%22%2C%22dist%22%3A%22precise%22%2C%22os%22%3A%22linux%22%7D%2C%22status%22%3A1%2C%22result%22%3A1%2C%22commit%22%3A%224fce43dfeaf8827e06c56c6f34f87342545199cc%22%2C%22branch%22%3A%22important-branch%22%2C%22message%22%3A%22add+travis+github+notifications%22%2C%22compare_url%22%3A%22https%3A%2F%2Fgithub.com%2Fopencounter%2Fopencounter%2Fcompare%2Fe7dd654b9386...4fce43dfeaf8%22%2C%22started_at%22%3A%222016-04-17T00%3A40%3A13Z%22%2C%22finished_at%22%3A%222016-04-17T00%3A43%3A35Z%22%2C%22committed_at%22%3A%222016-04-17T00%3A39%3A25Z%22%2C%22author_name%22%3A%22David+Hamp-Gonsalves%22%2C%22author_email%22%3A%22davidhampgonsalves%40gmail.com%22%2C%22committer_name%22%3A%22David+Hamp-Gonsalves%22%2C%22committer_email%22%3A%22davidhampgonsalves%40gmail.com%22%2C%22allow_failure%22%3Afalse%7D%5D%2C%22type%22%3A%22push%22%2C%22state%22%3A%22failed%22%2C%22pull_request%22%3Afalse%2C%22pull_request_number%22%3Anull%2C%22pull_request_title%22%3Anull%2C%22tag%22%3Anull%7D',
  }

  webhookTransmogrifier.process(eventJson, function(results) {
    t.equal(results.sent.length, 1, 'should be sent')
    t.same(results.sent[0].json, { message: 'Tests are Broken on important-branch b/c: add travis github notifications' }, 'should be expected message')
  }, configs)
})
